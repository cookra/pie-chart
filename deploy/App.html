<!DOCTYPE html>
<html>
<head>
    <title>Pie,Grid,etc</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>



    <script type="text/javascript">
        Rally.onReady(function () {
  Ext.define('CustomApp', {
     extend: 'Rally.app.App',
     componentCls: 'app',

     items: [
         {
         }
     ],
     launch: function(){
        this._makeStore();
     },
     _makeStore:function(){
        this._myStore = Ext.create('Rally.data.WsapiDataStore', {
           model: 'Test Case Result',
           fetch: true,
           autoLoad: true,
           listeners: {
                            load: this._onDataLoaded,
                            scope: this
            }
       });
     },
     _onDataLoaded: function(store, data) {
                    var records = [];
                    var verdictsGroups = ["Pass","Blocked","Error","Fail","Inconclusive"]

                    // State count variables
                    var passCount = 0;
                    var blockedCount = 0;
                    var errorCount = 0;
                    var failCount = 0;
                    var inconclusiveCount = 0;

                    // Loop through returned data and group/count by ScheduleState
                    Ext.Array.each(data, function(record) {
                        //Perform custom actions with the data here
                        //Calculations, etc.

                        verdict = record.get('Verdict');

                        switch(verdict)
                        {
                            case "Pass":
                               passCount++;
                                break;
                            case "Blocked":
                                blockedCount++;
                                break;
                            case "Error":
                                errorCount++;
                                break;
                            case "Fail":
                                failCount++;
                                break;
                            case "Inconclusive":
                                inconclusiveCount++;
                        }
                    });
                    if (this.down('#myChart')) {
                                this.remove('myChart');
                    }
                    this.add(
                        {
                            xtype: 'rallychart',
                            height: 400,
                            storeType: 'Rally.data.WsapiDataStore',
                            store: this._myStore,
                            itemId: 'myChart',
                            chartConfig: {
                                chart: {
                                },
                                title: {
                                    text: 'TestCaseResults Verdict Counts',
                                    align: 'center'
                                },
                                tooltip: {
                                    //pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>' //did not resolve {point.percentage:.1f}%
                                    /*
                                    formatter: function () { //was not even read
                                                   return this.point.name + ': <b>' + Highcharts.numberFormat(this.percentage, 1) + '%</b>';
                                               }
                                }    */                                
                                    formatter: function () {
                   return this.point.name + ': <b>' + Highcharts.numberFormat(this.percentage, 1) + '%</b>';
               }

                                },
                                plotOptions : {
                                     pie: {
                                        allowPointSelect: true,
                                        cursor: 'pointer',
                                        dataLabels: {
                                            enabled: true,
                                            color: '#000000',
                                            connectorColor: '#000000',
                                            //format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                                        }
                                    }
                                }
                            },            
                            chartData: {
                                categories: verdict, 
                                series: [ 
                                    {   
                                        type: 'pie',
                                        name: 'Verdicts',
                                        data: [
                                               ['Pass', passCount],
                                               ['Blocked',blockedCount],
                                                ['Error',errorCount],
                                                ['Fail',failCount],
                                                ['Inconclusive', inconclusiveCount]
                                              ]
                                    }
                                ]
                            }
                        }
                    );
                    this.down('#myChart')._unmask(); 
                }
     
 });

            
            Rally.launchApp('CustomApp', {
                name:"Pie,Grid,etc"
                //parentRepos:""
            });

        });
    </script>




    <style type="text/css">
.app {
     /* Add app styles here */
}

    </style>

</head>
<body></body>
</html>
